# Configuración de Variables de Entorno

Este documento describe las variables de entorno necesarias para ejecutar el sistema Courier Backend con Supabase (PostgreSQL).

## Archivo .env

El proyecto utiliza un archivo `.env` para almacenar las variables de entorno sensibles. Este archivo **NO debe ser commiteado** al repositorio.

### Cómo configurar

1. Copia el archivo `.env.example` a `.env`:
   ```bash
   cp .env.example .env
   ```

2. Edita el archivo `.env` con tus valores reales.

## Variables Requeridas

### Opción 1: Configuración con Session Pooler (Recomendado)

Supabase recomienda usar el Session Pooler para conexiones con SQLAlchemy. Esta configuración utiliza parámetros individuales:

**Variables requeridas:**
```
user=postgres.hlmngthhnvbdvbrxukqy
password=[YOUR_PASSWORD]
host=aws-1-us-east-2.pooler.supabase.com
port=5432
dbname=postgres
```

**Dónde encontrar los valores en Supabase:**
1. Ve a tu proyecto en Supabase
2. Navega a `Settings` → `Database` → `Connection Pooling`
3. Selecciona "Session" mode
4. Encontrarás:
   - **Host:** `aws-X-us-east-Y.pooler.supabase.com` (varía según tu región)
   - **Port:** `5432`
   - **Database:** `postgres`
   - **User:** `postgres.[project-ref]` (ejemplo: `postgres.hlmngthhnvbdvbrxukqy`)
   - **Password:** La contraseña de tu base de datos

**Ventajas del Session Pooler:**
- Mejor rendimiento con SQLAlchemy
- Gestión automática de conexiones
- Uso eficiente de recursos
- Configuración con `NullPool` para evitar conflictos de pooling

### Opción 2: Conexión Directa (Legacy)

**DATABASE_URL (Opcional - Retrocompatibilidad)**

**Descripción:** URL de conexión completa a la base de datos PostgreSQL de Supabase.

**Formato:**
```
DATABASE_URL=postgresql://[user]:[password]@[host]:[port]/[database]
```

**Ejemplo para Supabase (Direct Connection):**
```
DATABASE_URL=postgresql://postgres:tu_password_aqui@db.abcdefghijk.supabase.co:5432/postgres
```

**Nota:** Si defines los parámetros individuales (user, password, host, port, dbname), estos tendrán prioridad sobre DATABASE_URL.

**Nota importante para el plan gratuito de Supabase:**
- La base de datos se pausará automáticamente después de 1 semana de inactividad
- El proyecto tiene límites de 500MB de base de datos
- Máximo 2 proyectos activos

### SECRET_KEY (Requerida)

**Descripción:** Clave secreta para firmar los tokens JWT. Debe ser una cadena aleatoria y segura.

**Formato:**
```
SECRET_KEY=una-cadena-aleatoria-muy-larga-y-segura
```

**Cómo generar una clave segura:**
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

**Ejemplo:**
```
SECRET_KEY=Xk9mP2nQ4rT6wY8zA1bC3dE5fG7hJ9kL0mN2oP4qR6s
```

⚠️ **IMPORTANTE:** Esta clave debe ser única para cada entorno y nunca debe compartirse públicamente.

## Variables Opcionales

### JWT_ALGORITHM (Opcional)

**Descripción:** Algoritmo utilizado para firmar los tokens JWT.

**Valor por defecto:** `HS256`

**Valores posibles:** `HS256`, `HS384`, `HS512`

```
JWT_ALGORITHM=HS256
```

### ACCESS_TOKEN_EXPIRE_MINUTES (Opcional)

**Descripción:** Tiempo de expiración de los tokens JWT en minutos.

**Valor por defecto:** `30` (30 minutos)

```
ACCESS_TOKEN_EXPIRE_MINUTES=30
```

### ALLOWED_ORIGINS (Opcional)

**Descripción:** Lista de orígenes permitidos para CORS, separados por comas.

**Valor por defecto:** `*` (todos los orígenes - solo para desarrollo)

```
ALLOWED_ORIGINS=http://localhost:3000,https://mi-app.com
```

## Configuración de la Base de Datos en Supabase

Para configurar la base de datos en Supabase con el esquema del sistema Courier, ejecuta el siguiente script SQL en el SQL Editor de Supabase:

```sql
-- Create ENUM types first
CREATE TYPE usuario_rol AS ENUM ('admin', 'operador', 'cliente', 'transportista');
CREATE TYPE usuario_estado AS ENUM ('activo', 'inactivo');
CREATE TYPE cliente_tipo AS ENUM ('persona', 'empresa');
CREATE TYPE transportista_vehiculo AS ENUM ('moto', 'auto', 'camioneta', 'camion');
CREATE TYPE transportista_estado AS ENUM ('disponible', 'en_ruta', 'inactivo');
CREATE TYPE direccion_tipo AS ENUM ('residencial', 'comercial');
CREATE TYPE pedido_estado AS ENUM ('pendiente', 'procesando', 'en_ruta', 'entregado', 'cancelado');
CREATE TYPE pedido_prioridad AS ENUM ('normal', 'express');
CREATE TYPE tracking_estado AS ENUM ('recogido', 'en_ruta', 'entregado', 'fallido');
CREATE TYPE pago_metodo AS ENUM ('efectivo', 'tarjeta', 'transferencia');
CREATE TYPE pago_estado AS ENUM ('pendiente', 'completado', 'fallido');
CREATE TYPE factura_estado AS ENUM ('emitida', 'pagada', 'anulada');
CREATE TYPE ruta_estado AS ENUM ('pendiente', 'en_progreso', 'completada');
CREATE TYPE detalle_ruta_estado AS ENUM ('pendiente', 'completado', 'fallido');

-- Create tables
CREATE TABLE "Usuarios" (
    "id_usuario" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "email" varchar UNIQUE,
    "password_hash" varchar,
    "nombre" varchar,
    "apellido" varchar,
    "rol" usuario_rol,
    "estado" usuario_estado,
    "created_at" timestamp,
    "updated_at" timestamp
);

-- [El resto del esquema SQL proporcionado en el problema...]
```

## Configuración de Connection Pooling

Este proyecto está configurado para usar `NullPool` de SQLAlchemy cuando se conecta a PostgreSQL (incluyendo Supabase). Esto es importante porque:

1. **Supabase Session Pooler** ya gestiona las conexiones en el servidor
2. Evita conflictos entre el pooling del cliente (SQLAlchemy) y el pooling del servidor (Supabase)
3. Es la configuración recomendada en la documentación de SQLAlchemy: https://docs.sqlalchemy.org/en/20/core/pooling.html#switching-pool-implementations

La configuración se aplica automáticamente cuando usas parámetros individuales o DATABASE_URL con PostgreSQL.

## Ejemplo de archivo .env completo

### Con Session Pooler (Recomendado):
```bash
# Base de datos Supabase - Session Pooler
user=postgres.hlmngthhnvbdvbrxukqy
password=mi_password_segura
host=aws-1-us-east-2.pooler.supabase.com
port=5432
dbname=postgres

# Seguridad JWT
SECRET_KEY=Xk9mP2nQ4rT6wY8zA1bC3dE5fG7hJ9kL0mN2oP4qR6s
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# CORS (Opcional - solo para producción)
# ALLOWED_ORIGINS=https://mi-frontend.com
```

### Con DATABASE_URL (Conexión Directa - Legacy):
```bash
# Base de datos Supabase - Direct Connection
DATABASE_URL=postgresql://postgres:mi_password_segura@db.xyz123.supabase.co:5432/postgres

# Seguridad JWT
SECRET_KEY=Xk9mP2nQ4rT6wY8zA1bC3dE5fG7hJ9kL0mN2oP4qR6s
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# CORS (Opcional - solo para producción)
# ALLOWED_ORIGINS=https://mi-frontend.com
```

## Verificación

Para verificar que las variables de entorno están configuradas correctamente:

1. **Probar la conexión a la base de datos:**
   ```bash
   python test_supabase_connection.py
   ```
   Este script valida que la configuración del Session Pooler es correcta.

2. **Inicia el servidor:**
   ```bash
   python main.py
   ```

3. **Verifica que no haya errores** de conexión a la base de datos en la consola.

4. **Accede a la documentación interactiva:**
   ```
   http://localhost:8000/docs
   ```

5. **Prueba el endpoint de health check:**
   ```bash
   curl http://localhost:8000/health
   ```

## Seguridad

⚠️ **Recordatorios importantes:**
- Nunca comitees el archivo `.env` al repositorio
- Usa valores diferentes de `SECRET_KEY` para desarrollo, staging y producción
- En producción, considera usar un gestor de secretos (AWS Secrets Manager, HashiCorp Vault, etc.)
- Rota el `SECRET_KEY` periódicamente
- Usa contraseñas fuertes para la base de datos

## Troubleshooting

### Error: "No such file or directory: '.env'"
El archivo `.env` no existe. Copia `.env.example` a `.env` y configura tus valores.

### Error: "could not connect to server"
Verifica que:
- La URL de la base de datos sea correcta
- Tu proyecto Supabase esté activo (no pausado)
- Las credenciales sean correctas
- Tu IP tenga acceso (en Supabase, ve a Settings → Database → Connection pooling)

### Error: "JWT decode error"
El `SECRET_KEY` puede haber cambiado. Los tokens existentes quedarán inválidos. Los usuarios deben hacer login nuevamente.

### Plan gratuito de Supabase pausado
Si no usas tu proyecto por una semana, Supabase lo pausa automáticamente. Para reactivarlo:
1. Ve a tu proyecto en Supabase
2. Haz clic en "Restore" o "Unpause"
3. Espera unos minutos a que se active
